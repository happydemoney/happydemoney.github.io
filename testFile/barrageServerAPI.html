<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>barrage server API 调试</title>
    <style>
        h1 {
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>barrage server API 调试</h1>


    <script type="text/javascript" charset="utf-8" src="http://apps.bdimg.com/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="https://cdn.bootcss.com/socket.io/1.4.5/socket.io.min.js"></script>

    <script type="text/javascript" charset="utf-8">
        $(function () {

            GetSocketSeverfun('唱歌2 - 2016062301', '57716');

            // 点播测试
            var sjs = "album=false&autoPlay=true&userVideoID=" + '57717' + '&isView=true' + '&' + Math.random() * 100;
            var isLive = '0';
            var time = '';
            var expired = '';
            var secret = '';
            var cur_city = "未知";

            // 参数重置
            if (isLive == 1) {
                if (time != "" && null != time && secret != "" && null != secret) { //直播防盗链只有这两个参数，点播多一个expired
                    sjs = "album=false&autoPlay=true&playType=uLive&userVideoID=" + '57717' + '&time=' + time + "&secret=" + secret + "&"
                        + Math.random() * 100;
                } else {
                    sjs = "album=false&autoPlay=true&playType=uLive&userVideoID=" + '57717' + '&' + Math.random() * 100;
                }
            } else {
                if (time != "" && null != time && secret != "" && null != secret) { //直播防盗链只有这两个参数，点播多一个expired
                    sjs = "album=false&autoPlay=true&userVideoID=" + '57717' + '&time=' + time + "&expired=" + expired + "&secret=" + secret + "&"
                        + Math.random() * 100;
                }
            }

            //socket连接步奏1
            function GetSocketSeverfun(name, id) {
                // socket= io('http://192.168.1.90:30000')//socket地址
                if (isLive == 1) {
                    socket = io('http://192.168.1.206:3001');
                } else {
                    // socket = io('http://192.168.1.206:3000')
                    socket = io('http://192.168.1.206:3000');
                }
                console.log(socket);
                socket.on('connect', function () {
                    console.log('connect');
                    tellAs(name, id);//设置建联以后返回给as的去主动获取id
                })
                socket.emit("get_region");
                socket.on('client_region', function (region) {
                    if (typeof region != 'string') {
                        cur_city = "深圳";
                    } else {
                        cur_city = region;
                    }
                });
            }

            //as连接息连接步2
            function tellAs(name, id) {
                console.log(socket);
                socket.emit("open_barrage", name, id);
                socket.emit('get_id');
                socket.on('id', function (data) {
                    console.log(data);
                    //var aaa = document.getElementById("flashContent");
                    //YZobject.getObjectById("yzplayer_a1").JsBackAsOnlyID(data);
                })

                socket.on('reconnect_failed', function () {
                    console.log("error");
                })

                socket.on('connect_error', function () {
                    console.log("connect_error");
                });

                socket.on('disconnect', function () {
                    console.log("disconnect");
                });

                socket.on('connect_timeout', function () {
                    console.log("connect_timeout");
                });

                socket.on('error', function (err) {
                    console.log("error");
                });

                socket.on('server', function (data) {
                    console.log(data);
                    var msgs = JSON.parse(data);
                    console.log(msgs);
                    if (isLive == 1) {
                        if (msgs != null && msgs[0].usr_type == 0) {
                            var con = msgs[0].content.msg;
                            var reg = con.match(/\[[^@]{1,3}\]/g);
                            if (reg !== null) {
                                for (var i = 0; i < reg.length; i++) {
                                    con = con.replace(reg[i], '');
                                }
                            }
                            var msg = [{
                                "time": msgs[0].time,
                                "color": msgs[0].color,
                                "font": msgs[0].font,
                                "usr_id": msgs[0].usr_id,
                                "content": con
                            }];
                        }
                    } else {
                        msg = msgs;
                    }
                    //console.log(msg);
                    //YZobject.getObjectById("yzplayer_a1").JsBackAsMsg(msg);
                });
            }

            // 退出聊天室
            function CloseStockertoJs(name, id) {
                console.log('closeSocket');
                socket.emit('close_barrage', name, id);
            }

            //socket发送消息连接步1
            function GetSocketMsgfun(time) {
                console.log(time);
                socket.emit('get_msg', time);
            }

            //socket发送消息连接步21
            function SendMsgtoSocketfun(tim, cont, col, font, id) {
                var msg;
                // 直播
                if (isLive == 1) {
                    msg = {
                        'time': tim,
                        'content': {
                            "ip": cur_city,
                            "msg": cont
                        },
                        'color': col,
                        'font': font,
                        'usr_id': id,
                        'usr_type': 0
                    };
                } else {
                    // 点播
                    msg = {
                        'time': tim,
                        'content': cont,
                        'color': col,
                        'font': font,
                        'usr_id': id
                    };
                }
                socket.emit('message', JSON.stringify(msg));
            }

        });
    </script>
</body>

</html>